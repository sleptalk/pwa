<!DOCTYPE html>  
<html lang="es">  

<head>  
  <meta charset="UTF-8">  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Panel de administración</title>  
  <link rel="manifest" href="./manifest.json">  
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/16/5868/5868632.png" type="image/x-icon">  
  <style>  
    body {  
      margin: 0;  
      padding: 0;  
      height: 100vh;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      justify-content: center;  
      font-family: Arial, sans-serif;  
    }  

    #formulario {  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      margin-top: 20px;  
    }  

    input {  
      padding: 10px;  
      margin-bottom: 10px;  
      width: 200px;  
    }  

    button {  
      padding: 10px;  
      cursor: pointer;  
    }  

    #nombreChofer {  
      margin-top: 10px;  
      font-weight: bold;  
    }  
  </style>  
</head>  

<body>  
  <div id="mensajeUbicacion">Obteniendo ubicación...</div>  
  <div id="nombreChofer"></div>  

  <div id="formulario">  
    <input type="text" id="codigoConductor" placeholder="Ingrese el código del conductor">  
    <button id="btnEnviar">Enviar Código</button>  
    <button id="btnDetener" style="display:none;">Detener Ubicación</button>  
  </div>  

  <script>  
    let codigoIngresado = false;  

    // Función para iniciar la obtención de la ubicación en segundo plano  
    function iniciarUbicacionSegundoPlano(codigoConductor) {  
      if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {  
        navigator.serviceWorker.controller.postMessage({  
          action: "iniciar",  
          codigo: codigoConductor,  
        });  
      }  
    }  

    // Función para detener la obtención de la ubicación en segundo plano  
    function detenerUbicacionSegundoPlano() {  
      if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {  
        navigator.serviceWorker.controller.postMessage({  
          action: "detener",  
        });  
      }  
    }  

    // Manejar el envío del código del conductor  
    document.getElementById("btnEnviar").addEventListener("click", () => {  
      const codigoConductor = document.getElementById("codigoConductor").value;  
      if (codigoConductor) {  
        obtenerNombreConductor(codigoConductor);  
      }  
    });  

    // Función para obtener el nombre del conductor  
    function obtenerNombreConductor(codigo) {  
      const url = "https://script.google.com/macros/s/AKfycbx_kg6MTahza8LJ6USXH6DMk15cE19U39IeNuXgslHdQL5zGqiW-5FIBt6gjYLumz8txg/exec?codigo=" + codigo;  

      fetch(url)  
        .then((response) => response.json())  
        .then((data) => {  
          if (data.nombre) {  
            document.getElementById("nombreChofer").innerText = "Chofer: " + data.nombre;  
            codigoIngresado = true;  
            document.getElementById("codigoConductor").disabled = true;  
            iniciarUbicacionSegundoPlano(codigo); // Iniciar la ubicación en segundo plano  
            document.getElementById("btnDetener").style.display = "block"; // Mostrar botón de detener  
          } else {  
            document.getElementById("mensajeUbicacion").innerText = "Código no encontrado.";  
          }  
        })  
        .catch((error) => {  
          console.error("Error al obtener el nombre del conductor:", error);  
          document.getElementById("mensajeUbicacion").innerText = "Error al obtener el nombre del conductor.";  
        });  
    }  

    // Manejar el botón de detener  
    document.getElementById("btnDetener").addEventListener("click", () => {  
      detenerUbicacionSegundoPlano();  
      document.getElementById("btnDetener").style.display = "none"; // Ocultar botón de detener  
      document.getElementById("codigoConductor").disabled = false; // Habilitar el campo de código  
      document.getElementById("nombreChofer").innerText = ""; // Limpiar el nombre del chofer  
    });  

    // Escuchar mensajes del Service Worker  
    navigator.serviceWorker.addEventListener("message", (event) => {  
      if (event.data.action === "actualizarMensaje") {  
        document.getElementById("mensajeUbicacion").innerText = event.data.mensaje;  
      }  
    });  

    // Solicitar permisos de geolocalización al cargar la página  
    if ("geolocation" in navigator) {  
      navigator.geolocation.getCurrentPosition(  
        (position) => {  
          console.log("Permisos de geolocalización otorgados.");  
        },  
        (error) => {  
          console.error("Error al solicitar permisos de geolocalización:", error);  
          alert("Por favor, habilita los permisos de geolocalización en tu navegador.");  
        }  
      );  
    } else {  
      console.error("Geolocalización no soportada por este navegador.");  
    }  
  </script>  
</body>  

</html>  
