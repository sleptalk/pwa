<!DOCTYPE html>  
<html lang="es">  

<head>  
  <meta charset="UTF-8">  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Panel de administración</title>  
  <link rel="manifest" href="./manifest.json">  
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/16/5868/5868632.png" type="image/x-icon">  
  <style>  
    body {  
      margin: 0;  
      padding: 0;  
      height: 100vh;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      justify-content: center;  
      font-family: Arial, sans-serif;  
    }  
    #formulario {  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      margin-top: 20px;  
    }  
    input {  
      padding: 10px;  
      margin-bottom: 10px;  
      width: 200px; /* Ajusta el ancho según sea necesario */  
    }  
    button {  
      padding: 10px;  
      cursor: pointer;  
    }  
    #nombreChofer {  
      margin-top: 10px;  
      font-weight: bold;  
    }  
  </style>  
</head>  

<body>  
  <div id="mensajeUbicacion">Obteniendo ubicación...</div>  
  <div id="nombreChofer"></div>  

  <div id="formulario">  
    <input type="text" id="codigoConductor" placeholder="Ingrese el código del conductor">  
    <button id="btnEnviar">Enviar Código</button>  
  </div>  

  <script>  
    let codigoIngresado = false; // Variable para verificar si el código ya fue ingresado  
    let intervaloUbicacion; // Variable para almacenar el intervalo de actualización  

    // Función para obtener la ubicación  
    function obtenerUbicacion() {  
      console.log("Intentando obtener la ubicación...");  
      if (navigator.geolocation) {  
        navigator.geolocation.getCurrentPosition(  
          function (position) {  
            console.log("Ubicación obtenida:", position.coords.latitude, position.coords.longitude);  
            enviarUbicacion(position.coords.latitude, position.coords.longitude);  
          },  
          function (error) {  
            console.error("Error al obtener la ubicación:", error.message);  
            document.getElementById("mensajeUbicacion").innerText = "Error al obtener la ubicación: " + error.message;  
          }  
        );  
      } else {  
        console.error("Geolocalización no soportada por este navegador.");  
        document.getElementById("mensajeUbicacion").innerText = "Geolocalización no soportada por este navegador.";  
      }  
    }  

    // Función para enviar la ubicación al script de Google Apps Script  
    function enviarUbicacion(latitud, longitud) {  
      const codigoConductor = document.getElementById("codigoConductor").value; // Obtén el código del conductor desde el input  
      if (!codigoConductor) {  
        console.error("Código de conductor no encontrado.");  
        document.getElementById("mensajeUbicacion").innerText = "Primero debes ingresar un código de conductor.";  
        return;  
      }  

      const url = "https://script.google.com/macros/s/AKfycby9yGwf-bMSnwJg5j-XedzxuQV01pSJ9zkAwI1CHtttntQ6FAE9yxwcZwYcTu6ddmoI3w/exec";  
      const params = new URLSearchParams({  
        codigo: codigoConductor,  
        latitud: latitud.toFixed(5), // Asegúrate de que la latitud tenga 5 decimales  
        longitud: longitud.toFixed(5) // Asegúrate de que la longitud tenga 5 decimales  
      });  

      fetch(url + "?" + params.toString(), {  
        method: "GET",  
        mode: "no-cors" // Modo no-cors para evitar problemas de CORS  
      })  
        .then(() => {  
          console.log("Ubicación enviada correctamente.");  
          document.getElementById("mensajeUbicacion").innerText = "Ubicación actualizada: Latitud " + latitud.toFixed(5) + " | Longitud " + longitud.toFixed(5);  
        })  
        .catch((error) => {  
          console.error("Error al enviar la ubicación:", error);  
          document.getElementById("mensajeUbicacion").innerText = "Error al enviar la ubicación: " + error.message;  
        });  
    }  

    // Función para manejar el envío del código del conductor  
    document.getElementById("btnEnviar").addEventListener("click", function() {  
      const codigoConductor = document.getElementById("codigoConductor").value;  
      obtenerNombreConductor(codigoConductor);  
    });  

    // Función para obtener el nombre del conductor  
    function obtenerNombreConductor(codigo) {  
      const url = "https://script.google.com/macros/s/AKfycby9yGwf-bMSnwJg5j-XedzxuQV01pSJ9zkAwI1CHtttntQ6FAE9yxwcZwYcTu6ddmoI3w/exec" + codigo;  

      fetch(url)  
        .then(response => response.json())  
        .then(data => {  
          if (data.nombre) {  
            document.getElementById("nombreChofer").innerText = "Chofer: " + data.nombre;  
            codigoIngresado = true; // Marcar que el código ha sido ingresado  
            document.getElementById("codigoConductor").disabled = true; // Desactivar el campo de entrada  
            obtenerUbicacion(); // Obtener la ubicación después de ingresar el código  

            // Iniciar la actualización automática de la ubicación cada 20 segundos  
            intervaloUbicacion = setInterval(obtenerUbicacion, 20000);  
          } else {  
            document.getElementById("mensajeUbicacion").innerText = "Código no encontrado.";  
          }  
        })  
        .catch(error => {  
          console.error("Error al obtener el nombre del conductor:", error);  
          document.getElementById("mensajeUbicacion").innerText = "Error al obtener el nombre del conductor.";  
        });  
    }  
  </script>  
</body>  

</html>  
